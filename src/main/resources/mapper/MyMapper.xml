<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kanghwang.khholdings.domain.my.MyRepository">

    <select id="selectWalletById" resultType="WalletDTO">
        WITH latest_token_quotes AS (
            SELECT DISTINCT ON (token_id)
                token_id,
                closing_price
            FROM token_quotes
            WHERE unit = '1m'::quote_unit_enum
            ORDER BY token_id, created_at DESC
        ),
        wallet_stats AS (
            SELECT
                w.wallet_id,
                w.bank_name,
                w.account_no,
                w.cash_balance,
                COALESCE(SUM(h.purchased_value), 0) AS total_purchased_value,
                COALESCE(SUM(h.token_balance * ltq.closing_price), 0) AS total_market_value
            FROM wallets w
                LEFT JOIN holdings h ON w.wallet_id = h.wallet_id
                LEFT JOIN latest_token_quotes ltq ON h.token_id = ltq.token_id
            WHERE w.wallet_id = #{walletId}
            GROUP BY w.wallet_id, w.bank_name, w.account_no, w.cash_balance
        )
        SELECT
            bank_name AS bankName,
            account_no AS accountNo,
            cash_balance AS cashBalance,
            total_purchased_value AS totalPurchasedValue,
            total_market_value AS totalMarketValue,
            (cash_balance + total_market_value) AS totalBalance,
            (total_market_value - total_purchased_value) AS profitLoss,
            CASE
                WHEN total_purchased_value = 0 THEN 0
                ELSE (total_market_value - total_purchased_value) / total_purchased_value * 100
                END AS profitLossRate
        FROM wallet_stats
    </select>

    <select id="selectTokenByWalletId" parameterType="map" resultType="HoldingDTO">
        WITH latest_token_quotes AS (
            SELECT DISTINCT ON (token_id)
            token_id,
            closing_price
        FROM token_quotes
        WHERE unit = '1m'::quote_unit_enum
        ORDER BY token_id, created_at DESC
            )
        SELECT
            t.token_name           AS tokenName,
            t.ticker_symbol        AS tickerSymbol,
            h.token_balance        AS tokenBalance,
            h.purchased_value      AS purchasedValue,
            (h.token_balance * ltq.closing_price) AS marketValue,
            (h.token_balance * ltq.closing_price) - h.purchased_value AS profitLoss,
            CASE
                WHEN h.purchased_value = 0 THEN 0
                ELSE
                    ((h.token_balance * ltq.closing_price) - h.purchased_value)
                        / h.purchased_value * 100
                END AS profitLossRate
        FROM holdings h
                 JOIN tokens t
                      ON h.token_id = t.token_id
                 LEFT JOIN latest_token_quotes ltq
                           ON h.token_id = ltq.token_id
        WHERE h.wallet_id = #{walletId}
        ORDER BY t.token_name
            LIMIT 10
        OFFSET (#{page} - 1) * 10
    </select>

</mapper>
