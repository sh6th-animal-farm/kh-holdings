<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kanghwang.khholdings.domain.market.MarketRepository">

    <select id="selectAll" resultType="MarketDTO">
        WITH minute_stats AS (
            SELECT DISTINCT ON (token_id)
                token_id,
                closing_price AS market_price
            FROM token_quotes
            WHERE unit = '1m'::quote_unit_enum
            ORDER BY token_id, created_at DESC
        ),
        daily_stats AS (
            SELECT DISTINCT ON (token_id)
                token_id,
                trade_volume AS daily_trade_volume
            FROM token_quotes
            WHERE unit = '1d'::quote_unit_enum
            ORDER BY token_id, created_at DESC
        )
        SELECT
            t.token_id AS token_id,
            t.token_name AS token_name,
            t.ticker_symbol AS ticker_symbol,
            COALESCE(ms.market_price, 0) AS market_price,
            COALESCE(ds.daily_trade_volume, 0) AS daily_trade_volume
        FROM tokens t
                 LEFT JOIN minute_stats ms ON t.token_id = ms.token_id
                 LEFT JOIN daily_stats ds ON t.token_id = ds.token_id
        ORDER BY ds.daily_trade_volume DESC NULLS LAST
    </select>

    <select id="selectBySearch" resultType="MarketDTO">
        WITH minute_stats AS (
            SELECT DISTINCT ON (token_id)
                token_id,
                closing_price AS market_price
            FROM token_quotes
            WHERE unit = '1m'::quote_unit_enum
            ORDER BY token_id, created_at DESC
        ),
        daily_stats AS (
            SELECT DISTINCT ON (token_id)
                token_id,
                trade_volume AS daily_trade_volume
            FROM token_quotes
            WHERE unit = '1d'::quote_unit_enum
            ORDER BY token_id, created_at DESC
        )
        SELECT
            t.token_id AS token_id,
            t.token_name AS token_name,
            t.ticker_symbol AS ticker_symbol,
            COALESCE(ms.market_price, 0) AS market_price,
            COALESCE(ds.daily_trade_volume, 0) AS daily_trade_volume
        FROM tokens t
        LEFT JOIN minute_stats ms ON t.token_id = ms.token_id
        LEFT JOIN daily_stats ds ON t.token_id = ds.token_id
        <where>
            <if test="content != null and content != ''">
                (t.token_name ILIKE CONCAT('%', #{content}, '%')
                OR t.ticker_symbol ILIKE CONCAT('%', #{content}, '%'))
            </if>
        </where>
        ORDER BY ds.daily_trade_volume DESC NULLS LAST
    </select>

</mapper>